import{I as E,M as A,a as $,g as G,c as I,b as M,v as T,e as k,O as R,B as P,S as F,F as S,V as D,r as d,u as V,j as i,d as z,C as L,E as O,f as X,G as Y,h as B,i as K,N as Z,P as Q,L as W,k as q,l as H}from"./index-sjNXqTPx.js";function J(s){let e=[],t="";const n=I(s,{chained:!0,customRewriter({vertexShader:o,fragmentShader:r}){let a=[],c=[],l=[],m=M(o),f=M(r);return e.forEach(g=>{let u=m[g],h=f[g];const x=u||h;if(x){const U=new RegExp(`\\buniform\\s+${x}\\s+${g}\\s*;`,"g"),_=new RegExp(`\\b${g}\\b`,"g"),v=`troika_attr_${g}`,j=`troika_vary_${g}`;if(a.push(`attribute ${x} ${v};`),u&&(o=o.replace(U,""),o=o.replace(_,v)),h){r=r.replace(U,""),r=r.replace(_,j);let w=`varying ${h} ${j};`;a.push(w),l.push(w),c.push(`${j} = ${v};`)}}}),o=`${a.join(`
`)}
${o.replace(T,`
$&
${c.join(`
`)}`)}`,l.length&&(r=`${l.join(`
`)}
${r}`),{vertexShader:o,fragmentShader:r}}});n.setUniformNames=function(o){e=o||[];const r=e.sort().join("|");r!==t&&(t=r,this.needsUpdate=!0)};const p=n.customProgramCacheKey();return n.customProgramCacheKey=function(){return p+"|"+t},n.isInstancedUniformsMaterial=!0,n}class ee extends E{constructor(e,t,n){super(e,t,n),this._maxCount=n,this._instancedUniformNames=[]}get geometry(){let e=this._derivedGeometry;const t=this._baseGeometry;return(!e||e.baseGeometry!==t)&&(e=this._derivedGeometry=Object.create(t),e.baseGeometry=t,e.attributes=Object.create(t.attributes),t.addEventListener("dispose",function n(){t.removeEventListener("dispose",n),e.dispose()})),e}set geometry(e){this._baseGeometry=e}get material(){let e=this._derivedMaterial;const t=this._baseMaterial||this._defaultMaterial||(this._defaultMaterial=new A);return(!e||e.baseMaterial!==t)&&(e=this._derivedMaterial=J(t),t.addEventListener("dispose",function n(){t.removeEventListener("dispose",n),e.dispose()})),e.setUniformNames(this._instancedUniformNames),e}set material(e){if(Array.isArray(e))throw new Error("InstancedUniformsMesh does not support multiple materials");for(;e&&e.isInstancedUniformsMaterial;)e=e.baseMaterial;this._baseMaterial=e}get customDepthMaterial(){return this.material.getDepthMaterial()}get customDistanceMaterial(){return this.material.getDistanceMaterial()}setUniformAt(e,t,n){const p=this.geometry.attributes,o=`troika_attr_${e}`;let r=p[o];if(!r){const a=te(this._baseMaterial,e),c=se(a);if(r=p[o]=new $(new Float32Array(c*this._maxCount),c),a!==null)for(let l=0;l<this._maxCount;l++)C(r,l,a);this._instancedUniformNames=[...this._instancedUniformNames,e]}C(r,t,n),r.needsUpdate=!0}unsetUniform(e){this.geometry.deleteAttribute(`troika_attr_${e}`),this._instancedUniformNames=this._instancedUniformNames.filter(t=>t!==e)}}function C(s,e,t){let n=s.itemSize;n===1?s.setX(e,t):n===2?s.setXY(e,t.x,t.y):n===3?t.isColor?s.setXYZ(e,t.r,t.g,t.b):s.setXYZ(e,t.x,t.y,t.z):n===4?s.setXYZW(e,t.x,t.y,t.z,t.w):t.toArray?t.toArray(s.array,e*n):s.set(t,e*n)}function te(s,e){let t=s.uniforms;return t&&t[e]||(t=G(s).uniforms,t&&t[e])?t[e].value:null}function se(s){return s==null?0:typeof s=="number"?1:s.isVector2?2:s.isVector3||s.isColor?3:s.isVector4||s.isQuaternion?4:s.elements?s.elements.length:Array.isArray(s)?s.length:0}k({InstancedUniformsMesh:ee});const y=new R,b=new D,ie=`
  varying vec2 vUv;

  void main() {
    vUv = uv;
    vec4 mvPosition = vec4( position, 1.0 );

    #ifdef USE_INSTANCING
      mvPosition = instanceMatrix * mvPosition;
    #endif

    gl_Position = projectionMatrix * modelViewMatrix * mvPosition;
  }
`,ne=`
  varying vec2 vUv;
  uniform float uTime;
  uniform vec2 uUv;

  void main() {
    // gl_FragColor = vec4(uUv.x, 1.-uUv.y, sin(uTime), 1.);
    gl_FragColor = vec4(0.5 + 0.5*cos(uTime+uUv.xyx+vec3(0,2,4)), 1.);
    #include <tonemapping_fragment>
    // #include <encodings_fragment>
  }
`,N={uTime:{value:1},uUv:{value:new D(0,0)}},re=new P(.88,2,.88),oe=new F({uniforms:N,side:S,vertexShader:ie,fragmentShader:ne}),ae=s=>{const e=d.useRef(),{resolution:t,imgData:n}=s;return d.useEffect(()=>{console.log(n)},[n]),V(p=>{if(!e.current)return;const o=p.clock.getElapsedTime();N.uTime.value=o;let r=0,a=0;for(let c=0;c<t;c++)for(let l=0;l<t;l++){const m=r++;if(b.set(l/t,c/t),y.position.set(-t/2+l,0,-t/2+c),n){const f=(255-n[a])/255*t/30;y.scale.setY(Math.max(f,.1))}a+=4,y.updateMatrix(),e.current.setMatrixAt(m,y.matrix),e.current.setUniformAt("uUv",m,b)}e.current.instanceMatrix.needsUpdate=!0}),i.jsx("instancedUniformsMesh",{ref:e,args:[re,oe,t*t]})},me=()=>{const s=d.useRef(""),[e,t]=d.useState(""),[n,p]=d.useState(""),[o,r]=d.useState(),{resolution:a}=z({resolution:{value:30,options:[10,20,30,40,50,60,70,80,100]}}),c=l=>{s.current=l;const m=document.createElement("canvas");m.width=m.height=500;const f=m.getContext("2d");f.fillStyle="white",f.fillRect(0,0,500,500),f.font="bold 400px Noto Sans TC",f.fillStyle="black",f.textAlign="center",f.fillText(l,250,410,500);const g=m.toDataURL();t(g);const u=document.createElement("canvas");u.width=a,u.height=a;const h=u.getContext("2d");h.fillStyle="white",h.fillRect(0,0,500,500),h.imageSmoothingEnabled=!0,h.drawImage(m,0,0,m.width,m.height,0,0,u.width,u.height);const x=u.toDataURL();p(x),r(h.getImageData(0,0,a,a).data)};return d.useEffect(()=>{s.current&&c(s.current)},[a]),i.jsxs(i.Fragment,{children:[i.jsxs(d.Suspense,{children:[i.jsxs("div",{className:"ui-panel",children:[i.jsx("h2",{children:"Choose a charactor : "}),i.jsxs("ul",{children:[i.jsx("li",{onClick:()=>c("G"),children:"G"}),i.jsx("li",{onClick:()=>c("中"),children:"中"}),i.jsx("li",{onClick:()=>c("あ"),children:"あ"}),i.jsx("li",{onClick:()=>c("한"),children:"한"})]}),e?i.jsxs("div",{className:"flow",children:[i.jsxs("div",{className:"item",children:[i.jsx("h3",{children:"Texture preview : "}),i.jsx("img",{src:e,alt:"",width:"100px"})]}),i.jsx("div",{className:"item",children:i.jsx("span",{className:"arrow",children:"→"})}),i.jsxs("div",{className:"item",children:[i.jsx("h3",{children:"Downsampling : "}),i.jsx("img",{src:n,alt:"",width:"100px"})]})]}):null]}),i.jsxs(L,{dpr:[1,2],camera:{position:[-8,32,40],fov:45},children:[i.jsx("directionalLight",{position:[0,5,0],intensity:4}),i.jsx(O,{files:"./sunset.hdr",environmentIntensity:1}),i.jsx(X,{top:!0,children:i.jsx(ae,{resolution:a,imgData:o})}),i.jsx(Y,{renderOrder:-1,position:[0,0,0],infiniteGrid:!0,cellSize:.6,cellThickness:.6,sectionSize:3.3,sectionThickness:1.5,sectionColor:"#181818",fadeDistance:1e3}),i.jsx(B,{makeDefault:!0,enabled:!0,maxPolarAngle:Math.PI/3,minDistance:20,maxDistance:180}),i.jsx(ce,{}),i.jsx(K,{children:i.jsx(Z,{distanceFalloff:1,aoRadius:2,intensity:1})}),i.jsx(Q,{position:"top-left"})]})]}),i.jsx(W,{})]})},ce=()=>{const s=q(),[e,t]=d.useState(!1);return d.useEffect(()=>{e&&(console.log("degrade!"),s.setDpr(1))},[e]),i.jsx(H,{onDecline:()=>t(!0)})};export{me as default};
